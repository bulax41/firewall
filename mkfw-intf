#!/bin/bash
CHAIN_NAME="FORWARD"
SYSCONFIG="/etc/sysconfig/network-scripts"


usage () {
        echo
        echo "Usage: mkfw-intf 'IN/OUT/MGMT/TRADING/WAN' 'interface' 'ip address' 'gateway'"
        echo "Examples: "
        echo "          > mkfw-intf in eth0 10.1.2.10/24 10.1.2.1"
        echo
}


if [ $# -lt 3 ]; then
	echo "Incorrect number of arguments"
	echo
	usage
	exit
fi



DIRECTION=$(echo $1 |tr [:lower:] [:upper:])
INT=$(echo $2 |tr [:upper:] [:lower:])
NETWORK=$(ipcalc -n $3 | awk -F "=" '{print $2}')
PREFIX=$(ipcalc -p $3 | awk -F "=" '{print $2}')
GATEWAY=$4


# Delete Any Previous Rules For Interface
LINE=$(iptables -L $CHAIN_NAME -nv --line-numbers |awk "\$8 ~ /^$2\$/ {print \$1}")
if [ "x$LINE" != "x" ]; then
	iptables -D $CHAIN_NAME $LINE
fi

# Bring up interface on boot
cat > $SYSCONFIG/ifcfg-$INT <<-ENDCAT
TYPE=Ethernet
BOOTPROTO=none
DEVICE=$INT
ONBOOT=yes
ETHTOOL_OPTS=" -G $INT rx 4096; -G $INT tx 4096"
ENDCAT


## SET IP Address
vtysh -c "conf term" -c "int $2" -c "ip address $3" -c "end" -c "copy run start"

forwarding=0
# Insert iptables rule

if [ $DIRECTION == "TRADING" -o $DIRECTION == "WAN" ]
then
  TABLE=$(echo $DIRECTION |tr [:upper:] [:lower:])
  echo "0.0.0.0/0 via $GATEWAY table $TABLE" >> $SYSCONFIG/route-$INT
  iptables -I $CHAIN_NAME -o $2 -j OUTBOUND
  forwarding=1
elif [ $DIRECTION == "OUT" ]; then

  iptables -I $CHAIN_NAME -o $2 -j OUTBOUND
  forwarding=1
  vtysh -c "conf term" -c "ip route 0.0.0.0/0 $GATEWAY" -c "end" -c "copy run start"

elif [ $DIRECTION == "IN" ]; then

	iptables -I $CHAIN_NAME -o $2 -j INBOUND
  iptables -t mangle -I PREROUTING -i $2 -j OUTBOUND
	forwarding=1
  echo "pref 80 iif lo to $NETWORK/$PREFIX lookup main" >> $SYSCONFIG/rule-$INT

elif [ $DIRECTION == "MGMT" ]; then
  LINE=$(iptables -L INPUT -nv --line-numbers | tail -1 | awk '{print $1}')
  iptables -I INPUT $LINE -i $2 -j ACCEPT
  LINE=$(iptables -L OUTPUT -nv --line-numbers | tail -1 | awk '{print $1}')
  iptables -I OUTPUT $LINE -o $2 -j ACCEPT

  echo "pref 50 fwmark 101 lookup wan" >> $SYSCONFIG/rule-$INT
  echo "pref 51 fwmark 102 lookup trading" >> $SYSCONFIG/rule-$INT
  echo "pref 80 iif lo to $NETWORK/$PREFIX lookup main" >> $SYSCONFIG/rule-$INT
  echo "pref 100 iif lo to 10.0.0.0/8 lookup mgmt" >> $SYSCONFIG/rule-$INT
  echo "pref 100 iif lo to 192.168.0.0/16 lookup mgmt" >> $SYSCONFIG/rule-$INT
  echo "pref 100 iif lo to 172.16.0.0/12 lookup mgmt" >> $SYSCONFIG/rule-$INT
  echo "0.0.0.0/0 via $GATEWAY table mgmt " > $SYSCONFIG/route-$INT
else
  echo "Incorrect first arguement"
  usage
  exit
fi


#set sysctl variable for forwarding or not.
cat > /etc/sysctl.d/$INT.conf <<END
net.ipv4.conf.$INT.forwarding = $forwarding
net.ipv4.conf.$INT.rp_filter = 0
END

sysctl -w net.ipv4.conf.$INT.forwarding=$forwarding
sysctl -w net.ipv4.conf.$INT.rp_filter=0

service iptables save
ifup $2
