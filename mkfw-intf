#!/bin/bash


if [ "x$1" = "x" -o "y$2" = "y" -o "x$3" = "x" -o "z$4" = "z" ]; then
	echo
	echo "Usage: mkfw-intf 'IN/OUT' 'interface' 'NAT/NONAT' 'IP'"
	echo "Examples: "
	echo "          > mkfw-intf in eth2.199 nat 172.16.199.11/24"
	echo
	exit
fi

NAT=$(echo $3 |tr [:lower:] [:upper:])
CHAIN_NAME="FORWARD"
DIRECTION=$(echo $1 |tr [:lower:] [:upper:])
INT=$(echo $2 |tr [:lower:] [:upper:])
REDHATCONFIG="/etc/sysconfig/network-scripts"
UBUNTUCONFIG="/etc/network/interfaces"


############################
#
# Delete Rules For Interface
#
############################
# FORWARD Rule
LINE=$(iptables -L $CHAIN_NAME -nv --line-numbers |awk "\$8 ~ /^$2\$/ {print \$1}")
if [ "x$LINE" != "x" ]; then
	iptables -D $CHAIN_NAME $LINE
fi

# NAT Rule
LINENAT=$(iptables -t nat -L POSTROUTING -nv --line-numbers |awk "\$8 ~ /^$2\$/ {print \$1}")
if [ "x$LINENAT" != "x" ]; then
        iptables -t nat -D POSTROUTING $LINENAT

fi


############################
#
# Add Interface if not present
#
############################
if ! grep $2 $UBUNTUCONFIG; then
	cat >> $UBUNTUCONFIG <<-ENDCAT
	
	auto $2
	ENDCAT

fi

ifup $2

vtysh <<END
conf term
int $2
ip address $4
end
copy run start
END

############################
#
# Add Rules for Interface
#
############################
iptables -I $CHAIN_NAME -o $2 -j ${DIRECTION}BOUND
if [ $NAT = "NONAT" ]; then
	iptables -t nat -I POSTROUTING -o $2 -j ACCEPT
fi




